services:
  mysql:
    image: mariadb:10.11
    container_name: webchat_bridge_mysql
    restart: unless-stopped
    environment:
      MARIADB_DATABASE: ${MYSQL_DATABASE:-webchat_bridge}
      MARIADB_USER: ${MYSQL_USER:-webchat_bridge}
      MARIADB_PASSWORD: ${MYSQL_PASSWORD:-password}
      MARIADB_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-password}
    volumes:
      - ./data/mysql:/var/lib/mysql
    healthcheck:
      test:
        [
          "CMD",
          "mariadb-admin",
          "ping",
          "-h",
          "127.0.0.1",
          "-uroot",
          "-p${MYSQL_ROOT_PASSWORD:-password}",
        ]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 20s
    networks: [webchat_bridge]

  gateway:
    build: ./gateway
    container_name: webchat_bridge_gateway
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      NODE_ENV: production
      PORT: 3000

      # Reverse proxy support (Nginx Proxy Manager / Caddy / Cloudflare)
      # Set to 1 when the gateway is behind a proxy that sets X-Forwarded-For.
      TRUST_PROXY: ${TRUST_PROXY:-1}

      PUBLIC_BASE_URL: ${PUBLIC_BASE_URL}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}
      WIDGET_HMAC_SECRET: ${WIDGET_HMAC_SECRET}
      WIDGET_TOKEN_MAX_AGE_SECONDS: ${WIDGET_TOKEN_MAX_AGE_SECONDS:-300}
      ADMIN_API_KEY: ${ADMIN_API_KEY}
      TRACKING_RETENTION_DAYS: ${TRACKING_RETENTION_DAYS:-0}
      GEOIP_PROVIDER: ${GEOIP_PROVIDER:-ipapi}
      GEOIP_API_KEY: ${GEOIP_API_KEY:-}

      # Discord
      DISCORD_BOT_TOKEN: ${DISCORD_BOT_TOKEN}
      DISCORD_GUILD_ID: ${DISCORD_GUILD_ID}
      DISCORD_SUPPORT_CHANNEL_IDS: ${DISCORD_SUPPORT_CHANNEL_IDS}
      DISCORD_THREAD_TYPE: ${DISCORD_THREAD_TYPE}

      # DB
      DB_HOST: ${DB_HOST:-${MYSQL_HOST:-mysql}}
      DB_PORT: ${DB_PORT:-${MYSQL_PORT:-3306}}
      DB_NAME: ${DB_NAME:-${MYSQL_DATABASE}}
      DB_USER: ${DB_USER:-${MYSQL_USER}}
      DB_PASS: ${DB_PASS:-${MYSQL_PASSWORD}}

      # Logging
      DEBUG: ${DEBUG:-false}
      LOG_LEVEL: ${LOG_LEVEL:-info}

      # Email
      EMAIL_ENABLED: ${EMAIL_ENABLED:-false}
      EMAIL_PROVIDER: ${EMAIL_PROVIDER:-smtp}
      EMAIL_NOTIFY_TO: ${EMAIL_NOTIFY_TO:-}
      EMAIL_FROM: ${EMAIL_FROM:-}
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-25}
      SMTP_SECURE: ${SMTP_SECURE:-false}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASS: ${SMTP_PASS:-}

      # Ticket escalation
      TICKET_ALWAYS: ${TICKET_ALWAYS:-true}
      TICKET_CONTACT_PROMPT_MINUTES: ${TICKET_CONTACT_PROMPT_MINUTES:-180}
      TICKET_CONTACT_PROMPT_ONCE: ${TICKET_CONTACT_PROMPT_ONCE:-false}

    ports:
      - "${PORT:-3000}:3000"
    networks: [webchat_bridge]

networks:
  webchat_bridge:
    driver: bridge
